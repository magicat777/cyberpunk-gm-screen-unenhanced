<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cyberpunk GM Screen - Enhanced Edition</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#00ffff">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CP GM Screen">
  <meta name="msapplication-TileColor" content="#00ffff">
  <meta name="msapplication-TileImage" content="src/images/icon-192x192.png">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="src/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="src/images/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="src/images/apple-touch-icon.png">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="src/styles/design-system.css">
  <link rel="stylesheet" href="src/styles/cyberpunk-typography.css">
  <link rel="stylesheet" href="src/styles/cyberpunk-background.css">
  <link rel="stylesheet" href="src/styles/themes.css">
  <link rel="stylesheet" href="src/styles/enhanced-panels-fixed.css">
  <link rel="stylesheet" href="src/styles/cybernetic-theme.css">
  
  <style>
    :root {
      --header-height: 60px;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-primary);
      color: var(--text-primary);
      background: var(--bg-primary);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .main-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    /* Header Styles */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: var(--bg-surface);
      border-bottom: 2px solid var(--border-color);
      z-index: 10000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    .header-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .menu-toggle {
      padding: 8px 12px;
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 20px;
      border-radius: 4px;
      transition: all 0.3s;
    }
    
    .menu-toggle:hover {
      background: var(--bg-overlay);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .header-brand {
      display: flex;
      align-items: baseline;
      gap: 15px;
      flex: 1;
      margin-left: 20px;
    }
    
    .header-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: var(--font-display);
    }
    
    .header-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
    }
    
    .header-btn {
      padding: 8px 12px;
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 16px;
      border-radius: 4px;
      transition: all 0.3s;
    }
    
    .header-btn:hover {
      background: var(--bg-overlay);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    /* Side Tray Styles */
    .side-tray {
      position: fixed;
      top: var(--header-height, 60px);
      left: -300px;
      width: 300px;
      height: calc(100% - var(--header-height, 60px));
      background: var(--bg-surface);
      border-right: 2px solid var(--border-color);
      z-index: 9999;
      transition: left 0.3s ease;
      box-shadow: 2px 0 10px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .side-tray.open {
      left: 0;
    }
    
    .tray-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: rgba(0,0,0,0.5);
      border-bottom: 2px solid var(--border-color);
      flex-shrink: 0;
    }
    
    .tray-content-wrapper {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    .tray-content-wrapper::-webkit-scrollbar {
      width: 8px;
    }
    
    .tray-content-wrapper::-webkit-scrollbar-track {
      background: var(--bg-surface);
    }
    
    .tray-content-wrapper::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    .tray-content-wrapper::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }
    
    .tray-title {
      margin: 0;
      font-size: 1.2rem;
      color: var(--primary);
      font-family: var(--font-display);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .tray-close {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 20px;
      border-radius: 4px;
      transition: all 0.3s;
    }
    
    .tray-close:hover {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }
    
    .tray-content {
      padding: 20px;
    }
    
    .tray-section {
      margin-bottom: 30px;
    }
    
    .tray-section-title {
      margin: 0 0 15px 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .tray-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: var(--bg-overlay);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      cursor: pointer;
      font-family: var(--font-secondary);
      font-size: 14px;
      text-align: left;
      border-radius: 4px;
      transition: all 0.3s;
    }
    
    .tray-btn:hover:not(.disabled) {
      background: var(--bg-surface);
      border-color: var(--primary);
      color: var(--primary);
      box-shadow: var(--glow-small) var(--primary);
      transform: translateX(5px);
    }
    
    .tray-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .tray-btn .icon {
      font-size: 18px;
    }
    
    /* Footer Styles */
    .app-footer {
      background: var(--bg-surface);
      border-top: 2px solid var(--border-color);
      padding: 10px 20px;
      text-align: center;
      z-index: 10000;
    }
    
    .footer-content {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .footer-separator {
      margin: 0 10px;
      color: var(--border-color);
    }
    
    /* Minimized Panel Bar */
    .minimized-panel-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-surface);
      border-top: 2px solid var(--border-color);
      padding: 10px;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
    }
    
    .minimized-panels-container {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      scrollbar-width: thin;
    }
    
    .minimized-panel-btn {
      padding: 8px 16px;
      background: var(--bg-overlay);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      cursor: pointer;
      white-space: nowrap;
      font-family: var(--font-secondary);
      font-size: 14px;
      transition: all 0.3s;
      border-radius: 4px;
    }
    
    .minimized-panel-btn:hover {
      background: var(--bg-surface);
      border-color: var(--primary);
      color: var(--primary);
      box-shadow: var(--glow-small) var(--primary);
    }
    
    .quick-start {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }
    
    .quick-start-btn {
      padding: 10px 20px;
      background: var(--bg-overlay);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s;
      font-family: var(--font-secondary);
      font-size: 14px;
    }
    
    .quick-start-btn:hover {
      background: var(--bg-surface);
      border-color: var(--primary);
      color: var(--primary);
      box-shadow: var(--glow-small) var(--primary);
    }
    
    /* Mobile Panel System */
    .mobile-panel-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--bg-surface);
      border-top: 2px solid var(--primary);
      z-index: 9999;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .mobile-panel-tabs {
      display: flex;
      height: 100%;
      align-items: center;
      padding: 0 10px;
      gap: 10px;
      min-width: max-content;
    }
    
    .mobile-panel-tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      background: var(--bg-overlay);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 12px;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 80px;
    }
    
    .mobile-panel-tab.active {
      background: var(--primary);
      color: var(--bg-primary);
      border-color: var(--primary);
      box-shadow: var(--glow-small) var(--primary);
    }
    
    .mobile-panel-tab .icon {
      font-size: 20px;
      margin-bottom: 4px;
    }
    
    .mobile-add-panel {
      position: fixed;
      bottom: 70px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: var(--primary);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--bg-primary);
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      cursor: pointer;
      z-index: 9998;
      transition: all 0.3s;
    }
    
    .mobile-add-panel:active {
      transform: scale(0.95);
    }
    
    /* Mobile Panel Container adjustments */
    @media (max-width: 768px) {
      body {
        padding-bottom: 60px; /* Space for mobile nav */
      }
      
      .app-header {
        position: fixed;
        top: 0;
        height: 50px;
      }
      
      .header-title {
        font-size: 1.2rem;
      }
      
      .header-subtitle {
        display: none;
      }
      
      .main-container {
        padding-top: 50px;
        height: calc(100vh - 50px - 60px); /* Header and bottom nav */
        overflow: hidden;
      }
      
      .panel-container {
        height: 100%;
        padding: 0;
        overflow: hidden;
      }
      
      /* Hide desktop panel controls on mobile */
      .panel {
        position: fixed !important;
        top: 50px !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 60px !important;
        width: 100% !important;
        height: calc(100vh - 110px) !important;
        transform: none !important;
        margin: 0 !important;
        border-radius: 0 !important;
        display: none;
      }
      
      .panel.mobile-active {
        display: flex;
      }
      
      .panel-header {
        cursor: default !important;
        padding: 10px;
        min-height: 40px;
      }
      
      .panel-title {
        font-size: 14px;
      }
      
      .panel-control.minimize,
      .panel-control.maximize,
      .panel-control.close {
        display: none !important;
      }
      
      .panel-content {
        padding: 10px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .resize-handle {
        display: none !important;
      }
      
      /* Show mobile navigation */
      .mobile-panel-nav {
        display: block;
      }
      
      .mobile-add-panel {
        display: flex;
      }
      
      /* Side tray full screen on mobile */
      .side-tray {
        width: 100%;
        left: -100%;
        top: 0;
        height: 100%;
        z-index: 10001;
      }
      
      .side-tray.open {
        left: 0;
      }
      
      /* Minimized panel bar hidden on mobile */
      .minimized-panel-bar {
        display: none !important;
      }
      
      /* Quick start buttons hidden on mobile */
      .quick-start {
        display: none !important;
      }
      
      /* Footer hidden on mobile */
      .app-footer {
        display: none !important;
      }
      
      /* Touch feedback */
      .mobile-panel-tab:active {
        transform: scale(0.95);
        opacity: 0.8;
      }
      
      /* Swipe indicator */
      .swipe-indicator {
        position: fixed;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,255,255,0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        z-index: 9997;
      }
      
      .swipe-indicator.show {
        opacity: 1;
      }
    }
    
    /* Save indicator */
    .save-indicator {
      position: fixed;
      top: 70px;
      right: 20px;
      background: var(--bg-surface);
      border: 1px solid var(--success);
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      color: var(--success);
      opacity: 0;
      transform: translateX(100px);
      transition: all 0.3s;
      z-index: 10001;
      pointer-events: none;
    }
    
    .save-indicator.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .save-indicator::before {
      content: '‚úì ';
      margin-right: 5px;
    }
    
    /* Tablet adjustments */
    @media (min-width: 769px) and (max-width: 1024px) {
      .panel {
        max-width: 500px;
        max-height: 600px;
      }
      
      .panel-container {
        padding: 10px;
      }
    }
    
    /* Encounter Panel Styles */
    .encounter-panel-advanced {
      height: 100%;
      display: flex;
      flex-direction: column;
      color: var(--text-primary);
    }
    
    .encounter-controls {
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid var(--border-color);
    }
    
    .control-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .control-row.modifiers {
      margin-top: 15px;
    }
    
    .neon-select, .neon-select-small {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 4px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .neon-select:hover, .neon-select-small:hover {
      border-color: var(--primary);
      box-shadow: 0 0 5px var(--primary);
    }
    
    .neon-select:focus, .neon-select-small:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 10px var(--primary);
    }
    
    .neon-select-small {
      padding: 4px 8px;
      font-size: 14px;
    }
    
    .btn-primary, .btn-secondary {
      background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%);
      border: 2px solid var(--primary);
      color: var(--primary);
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-weight: bold;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary:hover {
      background: linear-gradient(180deg, #4a4a4a 0%, #3a3a3a 100%);
      box-shadow: 0 0 15px var(--primary);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .btn-secondary:hover {
      box-shadow: 0 0 10px var(--accent);
    }
    
    .btn-primary:disabled, .btn-secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .modifier-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .modifier-group label {
      font-size: 12px;
      text-transform: uppercase;
      opacity: 0.7;
    }
    
    .difficulty-slider {
      width: 100px;
    }
    
    .encounter-display {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .placeholder {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    .placeholder-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .placeholder h3 {
      color: var(--primary);
      margin-bottom: 10px;
      font-size: 24px;
      text-transform: uppercase;
    }
    
    .placeholder p {
      margin-bottom: 30px;
      opacity: 0.8;
    }
    
    .quick-presets h4 {
      color: var(--accent);
      margin-bottom: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- Audio preload elements for sound effects -->
  <audio id="dice-roll-sound" preload="auto">
    <source src="sounds/dice-roll.mp3" type="audio/mpeg">
    <source src="sounds/dice-roll.ogg" type="audio/ogg">
  </audio>
  <audio id="critical-hit-sound" preload="auto">
    <source src="sounds/critical-hit.mp3" type="audio/mpeg">
    <source src="sounds/critical-hit.ogg" type="audio/ogg">
  </audio>
  <audio id="combat-hit-sound" preload="auto">
    <source src="sounds/combat-hit.mp3" type="audio/mpeg">
    <source src="sounds/combat-hit.ogg" type="audio/ogg">
  </audio>
  <!-- Animated Background -->
  <!-- Will be added by JavaScript -->
  
  <!-- Header Bar -->
  <header class="app-header" id="appHeader">
    <div class="header-main">
      <div class="header-left">
        <button class="header-btn" onclick="themeManager.cycleTheme()" title="Change Theme">
          <span class="icon">üé®</span>
        </button>
        <button class="menu-toggle" onclick="toggleSideTray()" title="Toggle Menu">
          <span class="icon">‚ò∞</span>
        </button>
      </div>
      <div class="header-brand">
        <h1 class="header-title">
          <glitch-text text="Cyberpunk GM Screen" intensity="medium" speed="slow" hover-glitch></glitch-text>
        </h1>
        <span class="header-subtitle">Enhanced Edition</span>
        <div style="display: flex; gap: 8px; margin-left: 20px; align-items: center;">
          <div class="power-indicator" title="System Status"></div>
          <div class="cyber-led" title="Connection Status"></div>
          <div class="cyber-resistor" title="Neural Link"></div>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="showTemplatesDialog()" title="Quick Templates">
          <span class="icon">üìê</span>
          <span style="font-size: 12px; margin-left: 5px;">Templates</span>
        </button>
      </div>
    </div>
  </header>
  
  <!-- Side Tray -->
  <aside class="side-tray" id="sideTray">
    <div class="tray-header">
      <h3 class="tray-title">Tools & Features</h3>
      <button class="tray-close" onclick="toggleSideTray()">√ó</button>
    </div>
    <div class="tray-content-wrapper">
      <div class="tray-content">
      <div class="tray-section">
        <h4 class="tray-section-title">Create Panels</h4>
        <button class="tray-btn" onclick="createDicePanel()">
          <span class="icon">üé≤</span> Dice Roller
        </button>
        <button class="tray-btn" onclick="createCombatPanel()">
          <span class="icon">‚öîÔ∏è</span> Combat Tracker
        </button>
        <button class="tray-btn" onclick="createNotesPanel()">
          <span class="icon">üìù</span> Session Notes
        </button>
        <button class="tray-btn" onclick="createLoreBrowserPanel()">
          <span class="icon">üìö</span> Lore Database
        </button>
        <button class="tray-btn" onclick="createNPCPanel()">
          <span class="icon">üë•</span> NPC Generator
        </button>
        <button class="tray-btn" onclick="createLocationPanel()">
          <span class="icon">üè¢</span> Location Generator
        </button>
        <button class="tray-btn" onclick="createAdvancedEncounterPanel()">
          <span class="icon">‚ö°</span> Encounter Generator
        </button>
        <button class="tray-btn" onclick="createDebugPanel()">
          <span class="icon">üîß</span> Debug Panel
        </button>
        <button class="tray-btn" onclick="createPerformancePanel()">
          <span class="icon">üìä</span> Performance Monitor
        </button>
        <button class="tray-btn" onclick="createAllPanels()">
          <span class="icon">‚äï</span> Create All Panels
        </button>
      </div>
      <div class="tray-section">
        <h4 class="tray-section-title">Panel Templates</h4>
        <button class="tray-btn" onclick="showTemplatesDialog()">
          <span class="icon">üìê</span> Apply Template
        </button>
        <button class="tray-btn" onclick="saveCurrentAsTemplate()">
          <span class="icon">üíæ</span> Save Current Layout
        </button>
      </div>
      <div class="tray-section">
        <h4 class="tray-section-title">Panel Management</h4>
        <button class="tray-btn" onclick="fitPanelsToScreen()">
          <span class="icon">‚äû</span> Arrange Panels
        </button>
        <button class="tray-btn" onclick="minimizeAllPanels()">
          <span class="icon">‚äñ</span> Minimize All Panels
        </button>
        <button class="tray-btn" onclick="restoreAllPanels()">
          <span class="icon">‚äó</span> Restore All Panels
        </button>
        <button class="tray-btn danger" onclick="clearAllPanels()" style="border-color: var(--danger); color: var(--danger);">
          <span class="icon">√ó</span> Clear All Panels
        </button>
      </div>
      <div class="tray-section">
        <h4 class="tray-section-title">Layout Management</h4>
        <button class="tray-btn" onclick="exportLayout()">
          <span class="icon">üíæ</span> Export Layout
        </button>
        <button class="tray-btn" onclick="document.getElementById('importLayoutFile').click()">
          <span class="icon">üìÇ</span> Import Layout
        </button>
        <input type="file" id="importLayoutFile" accept=".json" style="display: none;" onchange="importLayout(event)">
      </div>
      <div class="tray-section">
        <h4 class="tray-section-title">Additional Tools</h4>
        <button class="tray-btn" onclick="createNetrunningPanel()">
          <span class="icon">üíª</span> Netrunning Interface
        </button>
        <button class="tray-btn" onclick="createSoundPanel()">
          <span class="icon">üîä</span> Sound Settings
        </button>
        <button class="tray-btn" onclick="createHelpPanel()">
          <span class="icon">‚ùì</span> Help & Shortcuts
        </button>
        <button class="tray-btn" onclick="createCollaborationPanel()">
          <span class="icon">ü§ù</span> Collaboration
        </button>
        <button class="tray-btn" onclick="createAtmospherePanel()">
          <span class="icon">üåÜ</span> Atmosphere
        </button>
        <button class="tray-btn" onclick="createAIAssistantPanel()">
          <span class="icon">ü§ñ</span> AI GM Assistant
        </button>
        <button class="tray-btn" onclick="createCampaignTrackerPanel()">
          <span class="icon">üìà</span> Campaign Tracker
        </button>
      </div>
      <div class="tray-section">
        <h4 class="tray-section-title">Campaign Management</h4>
        <button class="tray-btn" onclick="showCampaignDialog()">
          <span class="icon">üìä</span> Campaign Overview
        </button>
        <button class="tray-btn" onclick="exportCampaign()">
          <span class="icon">üíæ</span> Export Campaign
        </button>
        <button class="tray-btn" onclick="document.getElementById('importCampaignFile').click()">
          <span class="icon">üì•</span> Import Campaign
        </button>
        <input type="file" id="importCampaignFile" accept=".json,.cpgn" style="display: none;" onchange="importCampaign(event)">
        <button class="tray-btn danger" onclick="clearCampaignData()" style="border-color: var(--danger); color: var(--danger);">
          <span class="icon">üóëÔ∏è</span> Clear Campaign Data
        </button>
      </div>
      <div class="tray-section">
        <h4 class="tray-section-title">Keyboard Shortcuts</h4>
        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.8; padding: 0 16px;">
          <div><kbd style="background: var(--bg-overlay); padding: 2px 6px; border-radius: 3px; font-family: var(--font-mono);">1-9</kbd> - Quick switch panels</div>
          <div><kbd style="background: var(--bg-overlay); padding: 2px 6px; border-radius: 3px; font-family: var(--font-mono);">Alt + Tab</kbd> - Cycle panels</div>
          <div><kbd style="background: var(--bg-overlay); padding: 2px 6px; border-radius: 3px; font-family: var(--font-mono);">Esc</kbd> - Minimize active panel</div>
          <div><kbd style="background: var(--bg-overlay); padding: 2px 6px; border-radius: 3px; font-family: var(--font-mono);">Ctrl + ‚Üê‚Üë‚Üí‚Üì</kbd> - Move panel</div>
          <div><kbd style="background: var(--bg-overlay); padding: 2px 6px; border-radius: 3px; font-family: var(--font-mono);">Ctrl + Shift + ‚Üê‚Üë‚Üí‚Üì</kbd> - Move faster</div>
        </div>
      </div>
      <div class="tray-section">
        <h4 class="tray-section-title">Settings</h4>
        <button class="tray-btn" onclick="openThemeSelector()">
          <span class="icon">üé®</span> Theme Settings
        </button>
        <button class="tray-btn" onclick="togglePerformanceMode()">
          <span class="icon">‚ö°</span> Performance Mode
        </button>
        <button class="tray-btn" onclick="toggleSound()">
          <span class="icon">üîä</span> Sound: ON
        </button>
        <div class="volume-control" style="display: flex; align-items: center; padding: 8px 16px; gap: 10px;">
          <button onclick="adjustVolume(-0.1)" style="background: var(--bg-overlay); border: 1px solid var(--border-color); 
                  color: var(--text-primary); padding: 4px 8px; cursor: pointer; border-radius: 3px;">-</button>
          <span style="font-size: 12px; color: var(--text-secondary); min-width: 60px; text-align: center;">
            Volume: <span id="volumeDisplay">50%</span>
          </span>
          <button onclick="adjustVolume(0.1)" style="background: var(--bg-overlay); border: 1px solid var(--border-color); 
                  color: var(--text-primary); padding: 4px 8px; cursor: pointer; border-radius: 3px;">+</button>
        </div>
      </div>
    </div>
    </div>
  </aside>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Panel Container -->
    <div class="panel-container"></div>
    
    <!-- Minimized Panel Bar -->
    <div class="minimized-panel-bar" id="minimizedPanelBar" style="display: none;">
      <div class="minimized-panels-container" id="minimizedPanels"></div>
    </div>
  </div>
  
  <!-- Mobile Panel Navigation -->
  <nav class="mobile-panel-nav" id="mobilePanelNav">
    <div class="mobile-panel-tabs" id="mobilePanelTabs">
      <!-- Tabs will be dynamically added here -->
    </div>
  </nav>
  
  <!-- Mobile Add Panel Button -->
  <button class="mobile-add-panel" id="mobileAddPanel" onclick="toggleSideTray()">
    <span>+</span>
  </button>
  
  <!-- Save Indicator -->
  <div class="save-indicator" id="saveIndicator">Data Saved</div>
  
  <!-- Help Button -->
  <button class="help-button" onclick="window.helpSystem.showHelp()" title="Help & Tutorials">
    ?
  </button>
  
  <!-- Footer -->
  <footer class="app-footer" id="appFooter">
    <div class="footer-content">
      <span class="footer-text">Cyberpunk GM Screen ¬© 2025 | Built for Night City Game Masters</span>
      <span class="footer-separator">|</span>
      <span class="footer-text">Powered by Web Components & Modern CSS</span>
    </div>
  </footer>
  
  <!-- Audio Preload -->
  <audio id="diceRollSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
  </audio>
  <audio id="criticalSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRqQEAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YYAEAABQ/1r/Vv9a/1X/W/9U/1z/U/9d/1L/Xv9R/1//UP9g/0//Yf9O/2L/Tf9j/0z/ZP9L/2X/Sv9m/0n/Z/9I/2j/R/9p/0b/av9F/2v/RP9s/0P/bf9C/27/Qf9v/0D/cP8//3H/Pv9y/z3/c/88/3T/O/91/zr/dv85/3f/OP94/zf/ef82/3r/Nf97/zT/fP8z/33/Mv9+/zH/f/8w/4D/L/+B/y7/gv8t/4P/LP+E/yv/hf8q/4b/Kf+H/yj/iP8n/4n/Jv+K/yX/i/8k/4z/I/+N/yL/jv8h/4//IP+Q/x//kf8e/5L/Hf+T/xz/lP8b/5X/Gv+W/xn/l/8Y/5j/F/+Z/xb/mv8V/5v/FP+c/xP/nf8S/57/Ef+f/xD/oP8P/6H/Dv+i/w3/o/8M/6T/C/+l/wr/pv8J/6f/CP+o/wf/qf8G/6r/Bf+r/wT/rP8D/63/Av+u/wH/r/8A/7D/AP+x/wD/sv8A/7P/AP+0/wD/tf8A/7b/AP+3/wD/uP8A/7n/AP+6/wD/u/8A/7z/AP+9/wD/vv8A/7//AP/A/wD/wf8A/8L/AP/D/wD/xP8A/8X/AP/G/wD/x/8A/8j/AP/J/wD/yv8A/8v/AP/M/wD/zf8A/87/AP/P/wD/0P8A/9H/AP/S/wD/0/8A/9T/AP/V/wD/1v8A/9f/AP/Y/wD/2f8A/9r/AP/b/wD/3P8A/93/AP/e/wD/3/8A/+D/AP/h/wD/4v8A/+P/AP/k/wD/5f8A/+b/AP/n/wD/6P8A/+n/AP/q/wD/6/8A/+z/AP/t/wD/7v8A/+//AP/w/wD/8f8A//L/AP/z/wD/9P8A//X/AP/2/wD/9/8A//j/AP/5/wD/+v8A//v/AP/8/wD//f8A//7/AP///wD/AABhAGEAYQBhAGEAYQBhAGEAYQBhAGEAYQBhAGEAYQBhAGEAYQBhAGEAYQBhAGEAYQBhAGEAYQBhAGEAYQBhAGEA" type="audio/wav">
  </audio>
  <audio id="combatHitSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRjQDAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YRADAAD/fwCAAIAAgP9/AIAAgACA/38AgACAAID/fwCAAIAAgP9/AIAAgACA/38AgACAAID/fwCAAIAAgP9/AIAAgACA/38AgACAAID/fwCAAIAAgP9/AID/fwCAAIAAgP9//38AgACAAIAAgP9/AIAAgACA/38AgACAAID/fwCAAIAAgP9/AIAAgACA/38AgACAAID/fwCAAIAAgP9/AIAAgACA/38AgACAAID/fwCAAIAAgP9/AIAAgACA" type="audio/wav">
  </audio>
  
  <!-- Scripts -->
  <script src="src/js/cyberpunk-background.js"></script>
  <script src="src/js/core/theme-manager.js"></script>
  <script src="src/js/core/panel-system.js"></script>
  <script src="src/components/holo-button.js"></script>
  <script src="src/components/neon-input.js"></script>
  <script src="src/components/glitch-text.js"></script>
  <script src="src/components/cyber-card.js"></script>
  <script src="src/components/data-table.js"></script>
  <script src="src/components/loading-spinner.js"></script>
  <script src="src/components/error-message.js"></script>
  <script src="src/js/enhanced-dice-roller-fixed.js"></script>
  <script src="src/js/compact-dice-roller.js?v=3"></script>
  <script src="src/js/components/combat-tracker.js"></script>
  <script src="src/js/npc-generator.js"></script>
  <script src="src/js/enhanced-npc-generator.js"></script>
  <script src="src/js/rules-reference.js"></script>
  <script src="src/js/enhanced-rules-reference.js"></script>
  <script src="src/js/location-generator-implementation.js"></script>
  <script src="src/js/enhanced-location-generator.js"></script>
  <script src="src/js/encounter-generator-advanced.js"></script>
  <script src="src/js/encounter-panel-advanced.js"></script>
  <script src="src/js/encounter-panel-simple.js"></script>
  <script src="src/js/netrunning-interface.js"></script>
  <script src="src/js/netrunning-advanced.js"></script>
  <script src="src/js/netrunning-enhanced.js"></script>
  <script src="src/js/enhanced-lore-database.js"></script>
  <script src="src/js/enhanced-sound-system.js"></script>
  <script src="src/js/enhanced-performance-monitor.js"></script>
  <script src="src/js/virtual-scroll.js"></script>
  <script src="src/js/collaboration-system.js"></script>
  <script src="src/js/atmosphere-system.js"></script>
  <script src="src/js/ai-gm-assistant.js"></script>
  <script src="src/js/campaign-tracker.js"></script>
  <script src="src/js/panel-utils.js"></script>
  <script src="src/js/notes-text-editor.js"></script>
  <script src="src/js/module-index.js"></script>
  <script src="src/js/panel-templates.js"></script>
  <script src="src/js/help-system.js"></script>
  <script src="src/js/campaign-manager.js"></script>
  <script src="src/js/performance-optimizer.js"></script>
  
  <script>
    // Initialize systems on page load
    let background;
    let themeManager;
    let panelSystem;
    
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üéØ Initializing Cyberpunk GM Screen...');
      
      try {
        // Initialize animated background
        background = new CyberpunkBackground({
          circuits: true,
          rain: false,
          neonPulse: true,
          glitch: false,
          performance: 'high'
        });
        
        // Make background globally accessible
        window.background = background;
        
        // Initialize theme manager
        themeManager = new ThemeManager();
        window.themeManager = themeManager;
        
        // Clear corrupted panel data if needed
        try {
          const saved = localStorage.getItem('cyberpunk-panel-layout');
          if (saved) {
            const layout = JSON.parse(saved);
            // Check if any panel has object content
            if (layout.panels && layout.panels.some(p => typeof p.content === 'object')) {
              console.log('üîß Clearing corrupted panel data...');
              localStorage.removeItem('cyberpunk-panel-layout');
            }
          }
        } catch (e) {
          console.log('üîß Clearing invalid panel data...');
          localStorage.removeItem('cyberpunk-panel-layout');
        }
        
        // Initialize panel system
        panelSystem = new EnhancedPanelSystem({
          container: document.querySelector('.panel-container'),
          enableDocking: false,
          enableTabbing: true,
          enablePersistence: true
        });
        
        // Make panel system globally accessible
        window.panelSystem = panelSystem;
        
        // Set header height CSS variable
        const header = document.getElementById('appHeader');
        if (header) {
          const headerHeight = header.offsetHeight;
          document.documentElement.style.setProperty('--header-height', headerHeight + 'px');
          console.log('üìè Header height:', headerHeight + 'px');
        }
        
        console.log('‚úÖ All systems initialized successfully!');
        console.log('üí° Click the menu button (‚ò∞) to create panels');
        
        // Check if first time user
        if (window.helpSystem) {
          window.helpSystem.checkFirstTime();
        }
        
        // Listen for add-npc-to-combat events
        document.addEventListener('add-npc-to-combat', (event) => {
          const npcData = event.detail;
          
          // Find an open combat tracker
          const panels = Array.from(window.panelSystem.panels.values());
          const combatPanel = panels.find(p => p.title.includes('Combat Tracker'));
          
          if (combatPanel) {
            // Find the combat tracker instance
            const container = combatPanel.content.querySelector('[id^="combat-tracker-"]');
            if (container && container.combatTracker) {
              // Add the NPC to combat
              const tracker = container.combatTracker;
              const nameInput = container.querySelector('#combatant-name');
              const refInput = container.querySelector('#combatant-ref');
              const hpInput = container.querySelector('#combatant-hp');
              const bodyArmorInput = container.querySelector('#combatant-body-armor');
              const headArmorInput = container.querySelector('#combatant-head-armor');
              const typeSelect = container.querySelector('#combatant-type');
              
              if (nameInput && refInput && hpInput && bodyArmorInput && headArmorInput && typeSelect) {
                nameInput.value = npcData.name;
                refInput.value = npcData.ref;
                hpInput.value = npcData.hp;
                bodyArmorInput.value = npcData.bodyArmor;
                headArmorInput.value = npcData.headArmor;
                typeSelect.value = npcData.type;
                
                // Trigger the add button
                const addBtn = container.querySelector('#add-combatant');
                if (addBtn) addBtn.click();
              }
            }
          } else {
            alert('Please open a Combat Tracker panel first');
          }
        });
        
      } catch (error) {
        console.error('‚ùå Error during initialization:', error);
      }
    });
    
    // Panel creation functions
    function createDicePanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      const uniqueId = `dice-roller-${Date.now()}`;
      const panel = window.panelSystem.createPanel({
        title: 'DICE.SYS v2.1',
        content: `<div id="${uniqueId}" style="height: 100%; overflow: auto; background: rgba(0,0,0,0.9);"></div>`,
        position: { x: 50, y: 80 },
        size: { width: 320, height: 420 }
      });
      
      setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container && typeof CompactDiceRoller === 'function') {
          new CompactDiceRoller(container);
          
          // Override cached styles with inline styles
          const style = document.createElement('style');
          style.textContent = `
            #${uniqueId} .compact-dice-roller::before {
              display: none !important;
            }
            
            #${uniqueId} .compact-dice-roller {
              background: #1a1a1a !important;
              border: 2px solid #0ff !important;
              box-shadow: 0 0 20px rgba(0, 255, 255, 0.3) !important;
            }
            
            #${uniqueId} .quick-dice-btn {
              background: #2a2a2a !important;
              background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%) !important;
              border: 2px solid #0ff !important;
              color: #0ff !important;
              padding: 10px 6px !important;
              font-size: 13px !important;
              font-weight: bold !important;
              box-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.5),
                0 2px 4px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
              text-shadow: 0 0 5px rgba(0, 255, 255, 0.5) !important;
            }
            
            #${uniqueId} .quick-dice-btn:hover {
              background: #0ff !important;
              color: #000 !important;
              box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.8),
                0 4px 8px rgba(0, 0, 0, 0.5) !important;
              transform: translateY(-2px) !important;
              text-shadow: none !important;
            }
            
            #${uniqueId} .quick-dice-btn.exploding {
              background: linear-gradient(180deg, #3a2a3a 0%, #2a1a2a 100%) !important;
              color: #ff0080 !important;
              border-color: #ff0080 !important;
              text-shadow: 0 0 5px rgba(255, 0, 128, 0.8) !important;
            }
            
            #${uniqueId} .skill-check-compact {
              background: #1a1a1a !important;
              border: 2px solid #0ff !important;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5) !important;
            }
            
            #${uniqueId} .mini-input {
              background: #2a2a2a !important;
              border: 1px solid #0ff !important;
              color: #0ff !important;
              font-weight: bold !important;
            }
            
            #${uniqueId} .mod-btn {
              background: #2a2a2a !important;
              border: 1px solid #0ff !important;
              color: #0ff !important;
              font-weight: bold !important;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
            }
            
            #${uniqueId} .mod-btn.active {
              background: #0ff !important;
              color: #000 !important;
              box-shadow: 0 0 10px rgba(0, 255, 255, 0.8) !important;
            }
            
            #${uniqueId} .roll-action-btn {
              background: linear-gradient(180deg, #0ff 0%, #0aa 100%) !important;
              border: 2px solid #0ff !important;
              color: #000 !important;
              font-weight: bold !important;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5) !important;
            }
            
            #${uniqueId} .result-display {
              background: #000 !important;
              border: 2px solid #00ff41 !important;
              box-shadow: 
                0 0 10px rgba(0, 255, 65, 0.5),
                inset 0 0 10px rgba(0, 255, 65, 0.1) !important;
            }
            
            #${uniqueId} .result-display::before {
              display: none !important;
            }
            
            #${uniqueId} .special-btn {
              background: #2a2a2a !important;
              border: 2px solid #0aa !important;
              color: #0aa !important;
              font-weight: bold !important;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
            }
            
            #${uniqueId} .special-btn:hover {
              background: #0aa !important;
              color: #000 !important;
              box-shadow: 0 0 10px rgba(0, 170, 170, 0.8) !important;
            }
          `;
          container.appendChild(style);
        }
      }, 100);
    }
    
    function createCombatPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      const uniqueId = `combat-tracker-${Date.now()}`;
      const panel = window.panelSystem.createPanel({
        title: 'Advanced Combat Tracker',
        content: `<div id="${uniqueId}" style="height: 100%; overflow: auto;"></div>`,
        position: { x: 520, y: 80 },
        size: { width: 600, height: 500 }
      });
      
      setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container) {
          const tracker = new CyberpunkCombatTracker(container);
          container.combatTracker = tracker;
          window.combatTracker = tracker;
        }
      }, 100);
    }
    
    function createNotesPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      window.panelSystem.createPanel({
        title: 'Session Notes',
        content: `
          <div class="notes-panel">
            <textarea id="notesArea" style="width: 100%; height: 300px; background: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px; font-family: var(--font-secondary); resize: vertical;" placeholder="Type your notes here..."></textarea>
            <div style="margin-top: 10px; display: flex; justify-content: space-between;">
              <button onclick="saveNotes()" style="padding: 8px 16px; background: var(--bg-surface); border: 1px solid var(--success); color: var(--success); cursor: pointer;">Save</button>
              <button onclick="clearNotes()" style="padding: 8px 16px; background: var(--bg-surface); border: 1px solid var(--danger); color: var(--danger); cursor: pointer;">Clear</button>
            </div>
          </div>
        `,
        position: { x: 150, y: 150 },
        size: { width: 350, height: 350 }
      });
      
      // Load saved notes and setup auto-save
      setTimeout(() => {
        loadNotes();
        setupNotesAutoSave();
      }, 100);
    }
    
    function createNPCPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      const uniqueId = `enhanced-npc-generator-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'Enhanced NPC Generator',
        content: `<div id="${uniqueId}" style="height: 100%; overflow: auto;"></div>`,
        position: { x: 100, y: 100 },
        size: { width: 600, height: 700 }
      });
      
      setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container) {
          const npcGenerator = new EnhancedNPCGenerator(container);
          container.npcGenerator = npcGenerator;
          
          // Store reference for saved NPC methods
          container.loadNPC = (index) => npcGenerator.loadNPC(index);
          container.deleteNPC = (index) => npcGenerator.deleteNPC(index);
        }
      }, 100);
    }
    
    function createRulesPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      const uniqueId = `enhanced-rules-reference-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'Enhanced Rules Reference',
        content: `<div id="${uniqueId}" style="height: 100%; overflow: hidden;"></div>`,
        position: { x: 200, y: 150 },
        size: { width: 600, height: 700 }
      });
      
      setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container) {
          const rulesReference = new EnhancedRulesReference(container);
          container.rulesReference = rulesReference;
          
          // Store reference for HTML onclick handlers
          container.toggleRule = (ruleId) => rulesReference.toggleRule(ruleId);
          container.toggleBookmark = (ruleId) => rulesReference.toggleBookmark(ruleId);
          container.copyRule = (ruleId) => rulesReference.copyRule(ruleId);
          container.jumpToRule = (ruleId) => rulesReference.jumpToRule(ruleId);
        }
      }, 100);
    }
    
    function createLocationPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      const uniqueId = `location-generator-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'Location Generator',
        content: `
          <div id="${uniqueId}" class="location-generator" style="height: 100%; overflow: auto; padding: 20px;">
            <div class="location-controls">
              <div class="control-row">
                <select class="location-type" style="flex: 1; padding: 10px; background: var(--bg-surface); 
                        border: 1px solid var(--border-color); color: var(--text-primary); margin-right: 10px;">
                  <option value="random">Random Location</option>
                  <option value="bar">Bar/Nightclub</option>
                  <option value="shop">Shop/Store</option>
                  <option value="corp">Corporate Office</option>
                  <option value="apartment">Apartment Complex</option>
                  <option value="warehouse">Warehouse</option>
                  <option value="gang">Gang Territory</option>
                  <option value="restaurant">Restaurant/Food</option>
                  <option value="clinic">Clinic/Medical</option>
                  <option value="government">Government Building</option>
                  <option value="tech">Tech/Workshop</option>
                </select>
                <select class="location-district" style="flex: 1; padding: 10px; background: var(--bg-surface); 
                        border: 1px solid var(--border-color); color: var(--text-primary);">
                  <option value="random">Random District</option>
                  <option value="watson">Watson</option>
                  <option value="westbrook">Westbrook</option>
                  <option value="heywood">Heywood</option>
                  <option value="pacifica">Pacifica</option>
                  <option value="santo-domingo">Santo Domingo</option>
                  <option value="city-center">City Center</option>
                </select>
              </div>
              <div class="control-row" style="margin: 10px 0; display: flex; gap: 20px;">
                <label style="display: flex; align-items: center; color: var(--text-secondary);">
                  <input type="checkbox" class="include-npcs" checked style="margin-right: 5px;"> Include NPCs
                </label>
                <label style="display: flex; align-items: center; color: var(--text-secondary);">
                  <input type="checkbox" class="include-hooks" checked style="margin-right: 5px;"> Include Plot Hooks
                </label>
                <label style="display: flex; align-items: center; color: var(--text-secondary);">
                  <input type="checkbox" class="include-threats" checked style="margin-right: 5px;"> Include Threats
                </label>
              </div>
              <div class="control-row" style="display: flex; gap: 10px;">
                <holo-button class="generate-location-btn" variant="primary">Generate Location</holo-button>
                <holo-button class="save-location-btn" variant="success" disabled>Save Location</holo-button>
              </div>
            </div>
            
            <div class="location-display" style="margin-top: 20px;">
              <div class="location-tabs" style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button class="location-tab active" data-tab="details" 
                        style="padding: 8px 16px; background: var(--primary); border: none; 
                               color: var(--bg-primary); cursor: pointer;">Details</button>
                <button class="location-tab" data-tab="saved" 
                        style="padding: 8px 16px; background: var(--bg-surface); 
                               border: 1px solid var(--border-color); color: var(--text-primary); 
                               cursor: pointer;">Saved Locations</button>
                <button class="location-tab" data-tab="map" 
                        style="padding: 8px 16px; background: var(--bg-surface); 
                               border: 1px solid var(--border-color); color: var(--text-primary); 
                               cursor: pointer;">District Map</button>
              </div>
              
              <div class="location-tab-content" data-content="details">
                <div class="location-container" style="background: var(--bg-surface); 
                     border: 1px solid var(--border-color); padding: 20px; border-radius: 4px;">
                  <div class="location-placeholder" style="text-align: center; 
                       color: var(--text-secondary); padding: 40px;">
                    Click "Generate Location" to create a new location
                  </div>
                </div>
              </div>
              
              <div class="location-tab-content" data-content="saved" style="display: none;">
                <div class="location-list" style="background: var(--bg-surface); 
                     border: 1px solid var(--border-color); padding: 20px; border-radius: 4px; 
                     min-height: 200px;">
                  <div style="text-align: center; color: var(--text-secondary);">
                    No saved locations yet
                  </div>
                </div>
              </div>
              
              <div class="location-tab-content" data-content="map" style="display: none;">
                <div class="night-city-map" style="background: var(--bg-surface); 
                     border: 1px solid var(--border-color); padding: 20px; border-radius: 4px; 
                     text-align: center; color: var(--text-secondary);">
                  <div style="padding: 40px;">Night City district map coming soon...</div>
                </div>
              </div>
            </div>
          </div>
        `,
        position: { x: 150, y: 100 },
        size: { width: 550, height: 650 }
      });
      
      setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container && typeof EnhancedLocationGenerator === 'function') {
          const enhancedLocationGenerator = new EnhancedLocationGenerator(container);
          container.enhancedLocationGenerator = enhancedLocationGenerator;
        }
      }, 100);
    }
    
    function createLoreBrowserPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      const uniqueId = `lore-database-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'Lore Database',
        content: `<div id="${uniqueId}" class="lore-database-container" style="height: 100%; overflow: hidden;"></div>`,
        position: { x: 200, y: 150 },
        size: { width: 800, height: 600 }
      });
      
      setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container && typeof EnhancedLoreDatabase === 'function') {
          const loreDatabase = new EnhancedLoreDatabase(container);
          container.loreDatabase = loreDatabase;
        }
      }, 100);
    }
    
    function createDebugPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      const uniqueId = `debug-panel-${Date.now()}`;
      const panel = window.panelSystem.createPanel({
        title: 'Debug Tools',
        content: `<div id="${uniqueId}" style="height: 100%; overflow: auto; background: rgba(0,0,0,0.8); color: #0ff;">
          <style>
            #${uniqueId} .debug-tabs {
              display: flex;
              background: rgba(0,0,0,0.5);
              border-bottom: 2px solid #0ff;
              padding: 0;
            }
            #${uniqueId} .debug-tab {
              padding: 10px 20px;
              background: none;
              border: none;
              color: #0ff;
              cursor: pointer;
              font-family: var(--font-mono);
              border-bottom: 2px solid transparent;
              transition: all 0.3s;
            }
            #${uniqueId} .debug-tab:hover {
              background: rgba(0,255,255,0.1);
            }
            #${uniqueId} .debug-tab.active {
              border-bottom-color: #0ff;
              background: rgba(0,255,255,0.2);
            }
            #${uniqueId} .debug-tab-content {
              padding: 20px;
            }
            #${uniqueId} .debug-info-grid {
              display: grid;
              gap: 10px;
              margin-bottom: 20px;
            }
            #${uniqueId} .debug-info-row {
              display: grid;
              grid-template-columns: 150px 1fr;
              gap: 10px;
              padding: 5px;
              background: rgba(0,255,255,0.05);
              border: 1px solid rgba(0,255,255,0.2);
              font-size: 12px;
            }
            #${uniqueId} .debug-info-label {
              color: #0ff;
              font-weight: bold;
            }
            #${uniqueId} .debug-info-value {
              color: #fff;
              word-break: break-all;
              font-family: var(--font-mono);
            }
            #${uniqueId} .debug-tools button {
              padding: 8px 16px;
              margin: 5px;
              background: rgba(0,255,255,0.2);
              border: 1px solid #0ff;
              color: #0ff;
              cursor: pointer;
              font-family: var(--font-mono);
              transition: all 0.3s;
            }
            #${uniqueId} .debug-tools button:hover {
              background: rgba(0,255,255,0.3);
              box-shadow: 0 0 10px #0ff;
            }
            #${uniqueId} .console-output {
              background: #000;
              border: 1px solid #0ff;
              padding: 10px;
              height: 200px;
              overflow-y: auto;
              font-family: var(--font-mono);
              font-size: 12px;
            }
            #${uniqueId} .console-entry {
              margin-bottom: 5px;
              padding: 2px 5px;
            }
            #${uniqueId} .console-entry.error {
              color: #f00;
              background: rgba(255,0,0,0.1);
            }
            #${uniqueId} .console-entry.warn {
              color: #ff0;
              background: rgba(255,255,0,0.1);
            }
            #${uniqueId} .console-entry.info {
              color: #0ff;
            }
          </style>
          
          <div class="debug-tabs">
            <button class="debug-tab active" data-tab="system">System Info</button>
            <button class="debug-tab" data-tab="panels">Panel Debug</button>
            <button class="debug-tab" data-tab="storage">Storage</button>
            <button class="debug-tab" data-tab="console">Console</button>
          </div>
          
          <div class="debug-tab-content" id="${uniqueId}-system">
            <h3>System Information</h3>
            <div class="debug-info-grid">
              <div class="debug-info-row">
                <div class="debug-info-label">User Agent:</div>
                <div class="debug-info-value">${navigator.userAgent}</div>
              </div>
              <div class="debug-info-row">
                <div class="debug-info-label">Window Size:</div>
                <div class="debug-info-value" id="${uniqueId}-window-size">${window.innerWidth}px √ó ${window.innerHeight}px</div>
              </div>
              <div class="debug-info-row">
                <div class="debug-info-label">Pixel Ratio:</div>
                <div class="debug-info-value">${window.devicePixelRatio}</div>
              </div>
              <div class="debug-info-row">
                <div class="debug-info-label">Theme:</div>
                <div class="debug-info-value" id="${uniqueId}-theme">${document.body.getAttribute('data-theme') || 'default'}</div>
              </div>
              <div class="debug-info-row">
                <div class="debug-info-label">Document State:</div>
                <div class="debug-info-value">${document.readyState}</div>
              </div>
              <div class="debug-info-row">
                <div class="debug-info-label">Performance Mode:</div>
                <div class="debug-info-value" id="${uniqueId}-perf-mode">${window.performanceOptimizer?.performanceMode || 'N/A'}</div>
              </div>
              <div class="debug-info-row">
                <div class="debug-info-label">Memory Usage:</div>
                <div class="debug-info-value" id="${uniqueId}-memory">N/A</div>
              </div>
            </div>
            <div class="debug-tools">
              <button id="${uniqueId}-refresh-info">Refresh Info</button>
              <button id="${uniqueId}-check-functions">Check Core Functions</button>
            </div>
          </div>
          
          <div class="debug-tab-content" id="${uniqueId}-panels" style="display:none;">
            <h3>Panel Debugging</h3>
            <div class="debug-info-grid">
              <div class="debug-info-row">
                <div class="debug-info-label">Active Panels:</div>
                <div class="debug-info-value" id="${uniqueId}-active-panels">0</div>
              </div>
              <div class="debug-info-row">
                <div class="debug-info-label">Z-Index Range:</div>
                <div class="debug-info-value" id="${uniqueId}-z-index-range">N/A</div>
              </div>
            </div>
            <div class="debug-tools">
              <button id="${uniqueId}-list-panels">List All Panels</button>
              <button id="${uniqueId}-reset-positions">Reset Positions</button>
              <button id="${uniqueId}-check-overlaps">Check Overlaps</button>
            </div>
          </div>
          
          <div class="debug-tab-content" id="${uniqueId}-storage" style="display:none;">
            <h3>Local Storage</h3>
            <div class="debug-info-grid" id="${uniqueId}-storage-list">
              <!-- Storage items will be populated here -->
            </div>
            <div class="debug-tools">
              <button id="${uniqueId}-refresh-storage">Refresh</button>
              <button id="${uniqueId}-clear-storage">Clear All Storage</button>
              <button id="${uniqueId}-export-storage">Export Storage</button>
            </div>
          </div>
          
          <div class="debug-tab-content" id="${uniqueId}-console" style="display:none;">
            <h3>Console Output</h3>
            <div class="console-output" id="${uniqueId}-console-output">
              <div class="console-entry info">Console initialized...</div>
            </div>
            <div class="debug-tools">
              <button id="${uniqueId}-clear-console">Clear Console</button>
              <button id="${uniqueId}-export-logs">Export Logs</button>
            </div>
          </div>
        </div>`,
        position: { x: 100, y: 100 },
        size: { width: 600, height: 500 }
      });
      
      // Initialize debug panel functionality after creation
      setTimeout(() => {
        initializeDebugPanel(uniqueId);
      }, 100);
    }
    
    function createPerformancePanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      const uniqueId = `performance-panel-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'Performance Monitor',
        content: `<div id="${uniqueId}" class="performance-panel-container" style="height: 100%; overflow: auto;"></div>`,
        position: { x: 250, y: 200 },
        size: { width: 600, height: 500 }
      });
      
      setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container && window.performanceMonitor) {
          container.innerHTML = window.performanceMonitor.createPerformancePanel();
          window.performanceMonitor.attachPerformancePanelListeners(container);
          
          // Auto-refresh metrics every 2 seconds
          const refreshInterval = setInterval(() => {
            if (container.isConnected && window.performanceMonitor) {
              container.innerHTML = window.performanceMonitor.createPerformancePanel();
              window.performanceMonitor.attachPerformancePanelListeners(container);
            } else {
              clearInterval(refreshInterval);
            }
          }, 2000);
          
          container.refreshInterval = refreshInterval;
        }
      }, 100);
    }
    
    function createAllPanels() {
      const panels = [
        createDicePanel,
        createCombatPanel,
        createNotesPanel,
        createNPCPanel,
        createRulesPanel,
        createLocationPanel,
        createLoreBrowserPanel,
        createPerformancePanel,
        createAIAssistantPanel,
        createCampaignTrackerPanel
      ];
      
      // Create panels with staggered timing to avoid overwhelming the system
      panels.forEach((createFunc, index) => {
        setTimeout(() => {
          createFunc();
        }, index * 150);
      });
      
      // Fit all panels to screen after they're created
      setTimeout(() => fitPanelsToScreen(), panels.length * 150 + 200);
    }
    
    function fitPanelsToScreen() {
      if (window.panelSystem) {
        window.panelSystem.fitAllToScreen();
      }
    }
    
    function clearAllPanels() {
      if (window.panelSystem && confirm('Clear all panels? This will remove all current panels.')) {
        window.panelSystem.resetLayout();
      }
    }
    
    function minimizeAllPanels() {
      if (window.panelSystem) {
        window.panelSystem.minimizeAll();
      }
    }
    
    function restoreAllPanels() {
      if (!window.panelSystem) return;
      
      // Get all minimized panels and restore them
      window.panelSystem.panels.forEach(panel => {
        if (panel.state === 'minimized') {
          panel.restore();
        }
      });
    }
    
    function exportLayout() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      // Get the current layout
      const layout = {
        version: '1.0',
        timestamp: new Date().toISOString(),
        panels: Array.from(window.panelSystem.panels.values()).map(panel => ({
          id: panel.id,
          title: panel.title,
          position: panel.position,
          size: panel.size,
          state: panel.state,
          activeTab: panel.activeTab,
          content: panel.content,
          contentData: panel.getContentData(),
          preMinimizeState: window.panelSystem.minimizedPanels.get(panel.id) || null
        }))
      };
      
      // Convert to JSON
      const json = JSON.stringify(layout, null, 2);
      
      // Create blob and download link
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cyberpunk-panel-layout-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      console.log('‚úÖ Layout exported successfully');
    }
    
    function importLayout(event) {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const layout = JSON.parse(e.target.result);
          
          // Validate layout structure
          if (!layout.panels || !Array.isArray(layout.panels)) {
            throw new Error('Invalid layout format');
          }
          
          // Clear existing panels
          if (confirm('This will replace all current panels. Continue?')) {
            clearAllPanels();
            
            // Recreate panels from layout
            layout.panels.forEach((panelData, index) => {
              let panel;
              
              // Determine panel type based on title or ID
              if (panelData.title.includes('Dice Roller')) {
                // Create dice panel with saved position/size
                const uniqueId = `dice-roller-${Date.now()}-${index}`;
                panel = window.panelSystem.createPanel({
                  title: 'Enhanced Dice Roller',
                  content: `<div id="${uniqueId}" style="height: 100%; overflow: auto;"></div>`,
                  position: panelData.position,
                  size: panelData.size,
                  state: 'normal' // Set to normal initially
                });
                
                // Initialize dice roller after a delay
                setTimeout(() => {
                  const diceRoller = new EnhancedDiceRoller(`#${uniqueId}`);
                  diceRoller.init();
                }, 100);
                
              } else if (panelData.title.includes('Combat Tracker')) {
                // Create combat panel with saved position/size
                const uniqueId = `combat-tracker-${Date.now()}-${index}`;
                panel = window.panelSystem.createPanel({
                  title: 'Advanced Combat Tracker',
                  content: `<div id="${uniqueId}" style="height: 100%; overflow: auto;"></div>`,
                  position: panelData.position,
                  size: panelData.size,
                  state: 'normal'
                });
                
                // Initialize combat tracker after a delay
                setTimeout(() => {
                  const combatTracker = new AdvancedCombatTracker(`#${uniqueId}`);
                  combatTracker.init();
                }, 100);
                
              } else if (panelData.title.includes('Session Notes')) {
                // Create notes panel with saved position/size
                const uniqueId = `notes-${Date.now()}-${index}`;
                panel = window.panelSystem.createPanel({
                  title: 'Session Notes',
                  content: `<div id="${uniqueId}" style="height: 100%; overflow: auto;"></div>`,
                  position: panelData.position,
                  size: panelData.size,
                  state: 'normal'
                });
                
                // Initialize notes editor after a delay
                setTimeout(() => {
                  const notesEditor = new NotesTextEditor(`#${uniqueId}`);
                  notesEditor.init();
                }, 100);
                
              } else {
                // Generic panel
                panel = window.panelSystem.createPanel({
                  title: panelData.title,
                  content: panelData.content || '',
                  position: panelData.position,
                  size: panelData.size,
                  state: 'normal',
                  activeTab: panelData.activeTab || 0
                });
              }
              
              // Restore minimized state if needed
              if (panelData.preMinimizeState) {
                window.panelSystem.minimizedPanels.set(panel.id, panelData.preMinimizeState);
              }
              
              // Apply saved state after panel is created
              if (panelData.state === 'minimized') {
                setTimeout(() => panel.minimize(), 150);
              } else if (panelData.state === 'maximized') {
                setTimeout(() => panel.maximize(), 150);
              }
            });
            
            console.log('‚úÖ Layout imported successfully');
          }
        } catch (error) {
          console.error('Failed to import layout:', error);
          alert('Failed to import layout: ' + error.message);
        }
      };
      
      reader.readAsText(file);
      
      // Clear the file input
      event.target.value = '';
    }
    
    // Debug Panel Functions
    function initializeDebugPanel(uniqueId) {
      const container = document.getElementById(uniqueId);
      if (!container) return;
      
      // Tab switching
      const tabs = container.querySelectorAll('.debug-tab');
      const tabContents = container.querySelectorAll('.debug-tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.getAttribute('data-tab');
          
          // Update active tab
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Show corresponding content
          tabContents.forEach(content => {
            if (content.id === `${uniqueId}-${targetTab}`) {
              content.style.display = 'block';
            } else {
              content.style.display = 'none';
            }
          });
        });
      });
      
      // System Info functions
      const refreshInfoBtn = document.getElementById(`${uniqueId}-refresh-info`);
      if (refreshInfoBtn) {
        refreshInfoBtn.addEventListener('click', () => {
          document.getElementById(`${uniqueId}-window-size`).textContent = 
            `${window.innerWidth}px √ó ${window.innerHeight}px`;
          document.getElementById(`${uniqueId}-theme`).textContent = 
            document.body.getAttribute('data-theme') || 'default';
          
          // Update performance stats
          if (window.performanceOptimizer) {
            const stats = window.performanceOptimizer.getStats();
            document.getElementById(`${uniqueId}-perf-mode`).textContent = stats.mode.toUpperCase();
            document.getElementById(`${uniqueId}-memory`).textContent = 
              typeof stats.memory === 'object' ? `${stats.memory.used} / ${stats.memory.total}` : 'N/A';
          }
        });
      }
      
      const checkFunctionsBtn = document.getElementById(`${uniqueId}-check-functions`);
      if (checkFunctionsBtn) {
        checkFunctionsBtn.addEventListener('click', () => {
          const functions = [
            { name: 'Panel System', check: () => window.panelSystem !== undefined },
            { name: 'Theme Manager', check: () => window.themeManager !== undefined },
            { name: 'Background', check: () => window.background !== undefined },
            { name: 'Dice Roller', check: () => typeof EnhancedDiceRoller !== 'undefined' },
            { name: 'Combat Tracker', check: () => typeof AdvancedCombatTracker !== 'undefined' },
            { name: 'Notes Editor', check: () => typeof NotesTextEditor !== 'undefined' }
          ];
          
          let results = functions.map(f => `${f.name}: ${f.check() ? '‚úì' : '‚úó'}`).join('\\n');
          alert('Core Functions Check:\\n\\n' + results);
        });
      }
      
      // Panel Debug functions
      const updatePanelInfo = () => {
        const panels = window.panelSystem ? Array.from(window.panelSystem.panels.values()) : [];
        document.getElementById(`${uniqueId}-active-panels`).textContent = panels.length;
        
        if (panels.length > 0) {
          const zIndexes = panels.map(p => parseInt(p.element.style.zIndex) || 0);
          const minZ = Math.min(...zIndexes);
          const maxZ = Math.max(...zIndexes);
          document.getElementById(`${uniqueId}-z-index-range`).textContent = `${minZ} - ${maxZ}`;
        } else {
          document.getElementById(`${uniqueId}-z-index-range`).textContent = 'N/A';
        }
      };
      
      // Update panel info initially and on tab switch
      updatePanelInfo();
      
      const listPanelsBtn = document.getElementById(`${uniqueId}-list-panels`);
      if (listPanelsBtn) {
        listPanelsBtn.addEventListener('click', () => {
          const panels = window.panelSystem ? Array.from(window.panelSystem.panels.values()) : [];
          const list = panels.map(p => 
            `${p.title} (${p.state}) - Pos: ${p.position.x},${p.position.y} - Size: ${p.size.width}x${p.size.height}`
          ).join('\\n');
          alert('Active Panels:\\n\\n' + (list || 'No panels active'));
        });
      }
      
      const resetPositionsBtn = document.getElementById(`${uniqueId}-reset-positions`);
      if (resetPositionsBtn) {
        resetPositionsBtn.addEventListener('click', () => {
          if (window.panelSystem && confirm('Reset all panel positions?')) {
            window.panelSystem.fitAllToScreen();
          }
        });
      }
      
      // Storage functions
      const refreshStorage = () => {
        const storageList = document.getElementById(`${uniqueId}-storage-list`);
        if (!storageList) return;
        
        storageList.innerHTML = '';
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          const size = new Blob([value]).size;
          
          const row = document.createElement('div');
          row.className = 'debug-info-row';
          row.innerHTML = `
            <div class="debug-info-label">${key}:</div>
            <div class="debug-info-value">${size} bytes</div>
          `;
          storageList.appendChild(row);
        }
      };
      
      const refreshStorageBtn = document.getElementById(`${uniqueId}-refresh-storage`);
      if (refreshStorageBtn) {
        refreshStorageBtn.addEventListener('click', refreshStorage);
      }
      
      const clearStorageBtn = document.getElementById(`${uniqueId}-clear-storage`);
      if (clearStorageBtn) {
        clearStorageBtn.addEventListener('click', () => {
          if (confirm('Clear all local storage? This cannot be undone!')) {
            localStorage.clear();
            refreshStorage();
            alert('Local storage cleared');
          }
        });
      }
      
      const exportStorageBtn = document.getElementById(`${uniqueId}-export-storage`);
      if (exportStorageBtn) {
        exportStorageBtn.addEventListener('click', () => {
          const storage = {};
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            storage[key] = localStorage.getItem(key);
          }
          
          const blob = new Blob([JSON.stringify(storage, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `localstorage-backup-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
        });
      }
      
      // Console output
      const consoleOutput = document.getElementById(`${uniqueId}-console-output`);
      let consoleEntries = [];
      
      // Override console methods to capture output
      const originalLog = console.log;
      const originalError = console.error;
      const originalWarn = console.warn;
      
      const addConsoleEntry = (type, args) => {
        const entry = {
          type,
          message: Array.from(args).map(arg => 
            typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
          ).join(' '),
          timestamp: new Date().toLocaleTimeString()
        };
        
        consoleEntries.push(entry);
        
        if (consoleOutput) {
          const div = document.createElement('div');
          div.className = `console-entry ${type}`;
          div.textContent = `[${entry.timestamp}] ${entry.message}`;
          consoleOutput.appendChild(div);
          consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
      };
      
      console.log = function(...args) {
        originalLog.apply(console, args);
        addConsoleEntry('info', args);
      };
      
      console.error = function(...args) {
        originalError.apply(console, args);
        addConsoleEntry('error', args);
      };
      
      console.warn = function(...args) {
        originalWarn.apply(console, args);
        addConsoleEntry('warn', args);
      };
      
      const clearConsoleBtn = document.getElementById(`${uniqueId}-clear-console`);
      if (clearConsoleBtn) {
        clearConsoleBtn.addEventListener('click', () => {
          consoleEntries = [];
          consoleOutput.innerHTML = '<div class="console-entry info">Console cleared...</div>';
        });
      }
      
      const exportLogsBtn = document.getElementById(`${uniqueId}-export-logs`);
      if (exportLogsBtn) {
        exportLogsBtn.addEventListener('click', () => {
          const logs = consoleEntries.map(e => 
            `[${e.timestamp}] [${e.type.toUpperCase()}] ${e.message}`
          ).join('\\n');
          
          const blob = new Blob([logs], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `console-logs-${new Date().toISOString().split('T')[0]}.txt`;
          a.click();
          URL.revokeObjectURL(url);
        });
      }
    }
    
    // Side Tray Functions
    function toggleSideTray() {
      const tray = document.getElementById('sideTray');
      tray.classList.toggle('open');
    }
    
    function openThemeSelector() {
      const themes = ['cyberpunk', 'corpo', 'street-kid', 'nomad', 'netrunner'];
      const currentTheme = document.body.getAttribute('data-theme') || 'cyberpunk';
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-surface);
        border: 2px solid var(--border-color);
        padding: 20px;
        border-radius: 8px;
        z-index: 10002;
        min-width: 300px;
      `;
      
      dialog.innerHTML = `
        <h3 style="margin: 0 0 20px 0; color: var(--primary);">Select Theme</h3>
        ${themes.map(theme => `
          <button onclick="setTheme('${theme}'); this.parentElement.remove();" 
                  style="display: block; width: 100%; padding: 10px; margin-bottom: 10px;
                         background: ${theme === currentTheme ? 'var(--primary)' : 'var(--bg-overlay)'};
                         color: ${theme === currentTheme ? 'var(--bg-primary)' : 'var(--text-primary)'};
                         border: 1px solid var(--border-color); cursor: pointer; border-radius: 4px;">
            ${theme.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}
          </button>
        `).join('')}
        <button onclick="this.parentElement.remove();" 
                style="width: 100%; padding: 10px; background: var(--bg-overlay);
                       color: var(--text-primary); border: 1px solid var(--danger);
                       cursor: pointer; border-radius: 4px; margin-top: 10px;">
          Cancel
        </button>
      `;
      
      document.body.appendChild(dialog);
    }
    
    function setTheme(theme) {
      if (window.themeManager) {
        window.themeManager.setTheme(theme);
      }
    }
    
    function togglePerformanceMode() {
      if (window.performanceOptimizer) {
        const currentMode = window.performanceOptimizer.performanceMode;
        const modes = ['low', 'medium', 'high'];
        const currentIndex = modes.indexOf(currentMode);
        const newMode = modes[(currentIndex + 1) % modes.length];
        
        window.performanceOptimizer.performanceMode = newMode;
        window.performanceOptimizer.applyOptimizations();
        
        const btn = event.target.closest('button');
        btn.innerHTML = `<span class="icon">‚ö°</span> Performance: ${newMode.toUpperCase()}`;
        
        // Update background if available
        if (window.background) {
          window.background.setPerformance(newMode);
        }
      }
    }
    
    // Notes functions
    function saveNotes() {
      const notes = document.getElementById('notesArea').value;
      localStorage.setItem('cyberpunk-session-notes', notes);
      
      const textarea = document.getElementById('notesArea');
      textarea.style.borderColor = 'var(--success)';
      setTimeout(() => {
        textarea.style.borderColor = 'var(--border-color)';
      }, 1000);
    }
    
    // Auto-save notes
    function setupNotesAutoSave() {
      const notesArea = document.getElementById('notesArea');
      if (!notesArea) return;
      
      let saveTimeout;
      notesArea.addEventListener('input', () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          saveNotes();
        }, 1000); // Auto-save after 1 second of no typing
      });
    }
    
    function loadNotes() {
      const saved = localStorage.getItem('cyberpunk-session-notes');
      if (saved && document.getElementById('notesArea')) {
        document.getElementById('notesArea').value = saved;
      }
    }
    
    function clearNotes() {
      if (confirm('Clear all notes?')) {
        document.getElementById('notesArea').value = '';
        localStorage.removeItem('cyberpunk-session-notes');
      }
    }
    
    // Template Functions
    function showTemplatesDialog() {
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-surface);
        border: 2px solid var(--primary);
        border-radius: 4px;
        padding: 20px;
        z-index: 10004;
        min-width: 400px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
      `;
      
      const templates = window.panelTemplates.getAllTemplates();
      
      dialog.innerHTML = `
        <h3 style="margin: 0 0 20px 0; color: var(--primary); text-transform: uppercase; 
                   font-size: 18px; letter-spacing: 1px;">Panel Templates</h3>
        <div style="display: grid; gap: 10px;">
          ${Object.entries(templates).map(([id, template]) => `
            <div style="display: flex; align-items: center; gap: 15px; padding: 15px;
                        background: var(--bg-overlay); border: 1px solid var(--border-color);
                        cursor: pointer; transition: all 0.2s;"
                 onmouseover="this.style.borderColor='var(--primary)'"
                 onmouseout="this.style.borderColor='var(--border-color)'"
                 onclick="applyTemplate('${id}'); this.parentElement.parentElement.remove();">
              <span style="font-size: 24px;">${template.icon}</span>
              <div style="flex: 1;">
                <div style="font-weight: bold; color: var(--primary); margin-bottom: 5px;">
                  ${template.name}
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                  ${template.description}
                </div>
              </div>
              ${id.startsWith('custom-') || id.startsWith('imported-') ? `
                <button onclick="event.stopPropagation(); deleteTemplate('${id}'); this.parentElement.remove();"
                        style="background: var(--danger); border: none; color: white;
                               padding: 5px 10px; cursor: pointer; font-size: 12px;">
                  Delete
                </button>
              ` : ''}
            </div>
          `).join('')}
        </div>
        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
          <button onclick="document.getElementById('importTemplateFile').click();"
                  style="padding: 10px 20px; background: var(--bg-overlay);
                         border: 1px solid var(--primary); color: var(--primary);
                         cursor: pointer;">
            Import Template
          </button>
          <input type="file" id="importTemplateFile" accept=".json" style="display: none;" 
                 onchange="importTemplate(event); this.parentElement.parentElement.remove();">
          <button onclick="this.parentElement.parentElement.remove();" 
                  style="padding: 10px 20px; background: var(--bg-overlay);
                         border: 1px solid var(--danger); color: var(--danger);
                         cursor: pointer;">
            Cancel
          </button>
        </div>
      `;
      
      document.body.appendChild(dialog);
    }
    
    function applyTemplate(templateId) {
      if (window.panelTemplates) {
        window.panelTemplates.applyTemplate(templateId);
      }
    }
    
    function deleteTemplate(templateId) {
      if (window.panelTemplates) {
        window.panelTemplates.deleteCustomTemplate(templateId);
      }
    }
    
    function saveCurrentAsTemplate() {
      const name = prompt('Enter template name:');
      if (!name) return;
      
      const description = prompt('Enter template description (optional):') || '';
      
      try {
        if (window.panelTemplates) {
          window.panelTemplates.saveAsTemplate(name, description);
        }
      } catch (error) {
        alert('Failed to save template: ' + error.message);
      }
    }
    
    function importTemplate(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (window.panelTemplates) {
        window.panelTemplates.importTemplate(file)
          .catch(error => alert('Failed to import template: ' + error.message));
      }
      
      event.target.value = '';
    }
    
    // Campaign Management Functions
    function showCampaignDialog() {
      const stats = window.campaignManager.getCampaignStats();
      const campaign = window.campaignManager.currentCampaign;
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-surface);
        border: 2px solid var(--primary);
        border-radius: 4px;
        padding: 20px;
        z-index: 10004;
        min-width: 400px;
        max-width: 600px;
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
      `;
      
      dialog.innerHTML = `
        <h3 style="margin: 0 0 20px 0; color: var(--primary); text-transform: uppercase; 
                   font-size: 18px; letter-spacing: 1px;">Campaign Overview</h3>
        
        <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-overlay); 
                    border: 1px solid var(--border-color); border-radius: 4px;">
          <h4 style="margin: 0 0 10px 0; color: var(--accent); font-size: 16px;">
            ${campaign?.name || 'Untitled Campaign'}
          </h4>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; 
                      font-size: 14px; color: var(--text-secondary);">
            <div>üìä Panels: ${stats.panels}</div>
            <div>üë• NPCs: ${stats.npcs}</div>
            <div>üé≤ Dice Rolls: ${stats.diceRolls}</div>
            <div>‚öîÔ∏è Combatants: ${stats.combatants}</div>
            <div>üìù Notes: ${stats.notes} chars</div>
            <div>üìê Templates: ${stats.templates}</div>
            <div>üíæ Size: ${stats.sizeKB} KB</div>
            <div>üìÖ Modified: ${new Date(stats.lastModified).toLocaleDateString()}</div>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: space-between;">
          <button onclick="renameCampaign(); this.parentElement.parentElement.remove();"
                  style="padding: 10px 20px; background: var(--bg-overlay);
                         border: 1px solid var(--primary); color: var(--primary);
                         cursor: pointer;">
            Rename Campaign
          </button>
          <button onclick="this.parentElement.parentElement.remove();" 
                  style="padding: 10px 20px; background: var(--bg-overlay);
                         border: 1px solid var(--border-color); color: var(--text-secondary);
                         cursor: pointer;">
            Close
          </button>
        </div>
      `;
      
      document.body.appendChild(dialog);
    }
    
    function exportCampaign() {
      const includeHistory = confirm('Include roll history in export? (Larger file size)');
      window.campaignManager.exportCampaign({ includeHistory });
    }
    
    function importCampaign(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      window.campaignManager.importCampaign(file, { merge: false })
        .catch(error => console.error('Import failed:', error));
      
      event.target.value = '';
    }
    
    function clearCampaignData() {
      window.campaignManager.clearCampaignData();
    }
    
    function renameCampaign() {
      const newName = prompt('Enter new campaign name:', 
        window.campaignManager.currentCampaign?.name || 'Untitled Campaign');
      
      if (newName) {
        if (!window.campaignManager.currentCampaign) {
          window.campaignManager.createCampaign(newName);
        } else {
          window.campaignManager.currentCampaign.name = newName;
          window.campaignManager.currentCampaign.modified = new Date().toISOString();
          window.campaignManager.saveCurrentCampaign();
        }
        
        PanelUtils.showNotification('Campaign renamed', 'success');
      }
    }
    
    // Global save indicator
    function showSaveIndicator(message = 'Data Saved') {
      const indicator = document.getElementById('saveIndicator');
      if (!indicator) return;
      
      indicator.textContent = message;
      indicator.classList.add('show');
      
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 2000);
    }
    
    // Override localStorage.setItem to show save indicator
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
      originalSetItem.call(localStorage, key, value);
      
      // Show save indicator for specific keys
      if (key.includes('cyberpunk-')) {
        let message = 'Data Saved';
        if (key.includes('dice-history')) message = 'Dice History Saved';
        else if (key.includes('combat-tracker')) message = 'Combat State Saved';
        else if (key.includes('session-notes')) message = 'Notes Saved';
        else if (key.includes('panel-layout')) message = 'Layout Saved';
        
        showSaveIndicator(message);
      }
    };
    
    // Sound controls
    function toggleSound() {
      if (window.soundManager) {
        window.soundManager.toggle();
        const btn = event.target.closest('button');
        btn.innerHTML = `<span class="icon">üîä</span> Sound: ${window.soundManager.enabled ? 'ON' : 'OFF'}`;
      }
    }
    
    function adjustVolume(delta) {
      if (window.soundManager) {
        const newVolume = Math.max(0, Math.min(1, window.soundManager.volume + delta));
        window.soundManager.setVolume(newVolume);
        document.getElementById('volumeDisplay').textContent = Math.round(newVolume * 100) + '%';
      }
    }
  </script>
  
  <!-- Sound Manager -->
  <script src="src/js/sound-manager.js"></script>
  <script>
    // Initialize sound manager
    window.soundManager = new SoundManager();
    
    // Additional panel creation functions
    function createNetrunningPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      const uniqueId = `netrunning-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'Enhanced Netrunning Interface',
        content: `<netrunning-enhanced id="${uniqueId}"></netrunning-enhanced>`,
        position: { x: 100, y: 50 },
        size: { width: 1000, height: 700 }
      });
    }
    
    function createSoundPanel() {
      if (!window.panelSystem || !window.soundSystem) {
        console.error('Panel system or sound system not initialized');
        return;
      }
      
      const uniqueId = `sound-settings-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'Sound Settings',
        content: `<div id="${uniqueId}" style="height: 100%; overflow: auto;"></div>`,
        position: { x: 400, y: 250 },
        size: { width: 350, height: 400 }
      });
      
      setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container && window.soundSystem) {
          container.innerHTML = window.soundSystem.createSettingsPanel();
          window.soundSystem.attachSettingsListeners(container);
        }
      }, 100);
    }
    
    function createHelpPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      window.panelSystem.createPanel({
        title: 'Help & Shortcuts',
        content: `
          <div style="padding: 20px; height: 100%; overflow: auto;">
            <h3 style="color: var(--primary); margin-bottom: 15px;">Keyboard Shortcuts</h3>
            <div style="font-size: 14px; line-height: 1.8;">
              <div><kbd>Ctrl+D</kbd> - Open Dice Roller</div>
              <div><kbd>Ctrl+N</kbd> - Create Note</div>
              <div><kbd>Ctrl+S</kbd> - Save Layout</div>
              <div><kbd>Ctrl+O</kbd> - Open Layout</div>
              <div><kbd>Esc</kbd> - Close Active Panel</div>
              <div><kbd>1-9</kbd> - Quick Switch Panels</div>
              <div><kbd>Ctrl+Shift+F</kbd> - Fit All Panels</div>
              <div><kbd>Ctrl+Shift+M</kbd> - Minimize All</div>
            </div>
            
            <h3 style="color: var(--primary); margin: 20px 0 15px;">Panel Controls</h3>
            <div style="font-size: 14px; line-height: 1.8;">
              <div>‚Ä¢ Drag panel headers to move</div>
              <div>‚Ä¢ Drag panel edges to resize</div>
              <div>‚Ä¢ Double-click header to minimize</div>
              <div>‚Ä¢ Click X to close panel</div>
              <div>‚Ä¢ Right-click for context menu</div>
            </div>
            
            <h3 style="color: var(--primary); margin: 20px 0 15px;">Tips</h3>
            <div style="font-size: 14px; line-height: 1.8;">
              <div>‚Ä¢ Save layouts for different scenarios</div>
              <div>‚Ä¢ Use templates for quick setup</div>
              <div>‚Ä¢ Export campaign data regularly</div>
              <div>‚Ä¢ Enable sound for immersive experience</div>
            </div>
          </div>
        `,
        position: { x: 350, y: 150 },
        size: { width: 400, height: 500 }
      });
    }
    
    function createCollaborationPanel() {
      if (!window.panelSystem || !window.collaborationSystem) {
        console.error('Panel system or collaboration system not initialized');
        return;
      }
      
      const uniqueId = `collaboration-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'Collaboration',
        content: `<div id="${uniqueId}" style="height: 100%; overflow: auto;"></div>`,
        position: { x: 500, y: 100 },
        size: { width: 350, height: 500 }
      });
      
      setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container && window.collaborationSystem) {
          container.innerHTML = window.collaborationSystem.createCollaborationPanel();
          
          // Update panel on connection events
          ['room-created', 'peer-connected', 'peer-disconnected', 'disconnected'].forEach(event => {
            document.addEventListener('collaboration-' + event, () => {
              if (container.isConnected) {
                container.innerHTML = window.collaborationSystem.createCollaborationPanel();
              }
            });
          });
        }
      }, 100);
    }
    
    function createAtmospherePanel() {
      if (!window.panelSystem || !window.atmosphereSystem) {
        console.error('Panel system or atmosphere system not initialized');
        return;
      }
      
      const uniqueId = `atmosphere-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'Atmosphere Control',
        content: `<div id="${uniqueId}" style="height: 100%; overflow: auto;"></div>`,
        position: { x: 600, y: 150 },
        size: { width: 300, height: 450 }
      });
      
      setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container && window.atmosphereSystem) {
          container.innerHTML = window.atmosphereSystem.createControlPanel();
        }
      }, 100);
    }
    
    function createAIAssistantPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      const uniqueId = `ai-assistant-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'AI GM Assistant',
        content: `<ai-gm-assistant id="${uniqueId}"></ai-gm-assistant>`,
        position: { x: 100, y: 100 },
        size: { width: 600, height: 700 }
      });
    }
    
    function createCampaignTrackerPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      const uniqueId = `campaign-tracker-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'Campaign Tracker',
        content: `<campaign-tracker id="${uniqueId}"></campaign-tracker>`,
        position: { x: 200, y: 80 },
        size: { width: 800, height: 600 }
      });
    }
    
    function createAdvancedEncounterPanel() {
      if (!window.panelSystem) {
        console.error('Panel system not initialized');
        return;
      }
      
      const uniqueId = `encounter-panel-${Date.now()}`;
      window.panelSystem.createPanel({
        title: 'Encounter Generator',
        content: `<div id="${uniqueId}" style="height: 100%; overflow: hidden;"></div>`,
        position: { x: 300, y: 100 },
        size: { width: 700, height: 600 }
      });
      
      // Initialize the encounter panel after DOM is ready
      setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container) {
          // Use the simpler implementation that handles dynamic DOM better
          if (window.SimpleEncounterPanel) {
            new SimpleEncounterPanel(uniqueId);
          } else if (window.AdvancedEncounterPanel) {
            // Fallback to advanced panel if available
            new AdvancedEncounterPanel(uniqueId);
          } else {
            // Final fallback
            container.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #0ff;">
                <h3 style="color: #f0f; margin-bottom: 20px;">Encounter Generator</h3>
                <p style="margin-bottom: 20px; color: #f00;">Error: Encounter generator scripts not loaded</p>
                <button onclick="location.reload()" class="btn-primary">Reload Page</button>
              </div>
            `;
          }
        }
      }, 100);
    }
  </script>
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then((registration) => {
            console.log('Service Worker registered:', registration);
            
            // Check for updates periodically
            setInterval(() => {
              registration.update();
            }, 60 * 60 * 1000); // Check every hour
            
            // Handle updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New update available
                  if (confirm('New version available! Reload to update?')) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.error('Service Worker registration failed:', error);
          });
        
        // Handle service worker messages
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data.type === 'UPDATE_AVAILABLE') {
            PanelUtils.showNotification('Update available! Reload to get the latest version.', 'info');
          }
          
          if (event.data.type === 'SYNC_CAMPAIGN_DATA') {
            // Sync campaign data
            if (window.campaignManager) {
              const data = window.campaignManager.gatherCampaignData();
              navigator.serviceWorker.controller.postMessage({
                type: 'CACHE_CAMPAIGN_DATA',
                data: data
              });
            }
          }
        });
      });
      
      // Enable background sync
      if ('sync' in self.registration) {
        window.addEventListener('beforeunload', () => {
          self.registration.sync.register('sync-campaign-data');
        });
      }
      
      // Request notification permission for updates
      if ('Notification' in window && Notification.permission === 'default') {
        // Don't ask immediately, wait for user interaction
        document.addEventListener('click', () => {
          Notification.requestPermission();
        }, { once: true });
      }
    }
  </script>
  
  <!-- Test Suite (Development Only) -->
  <script src="src/js/panel-test-suite.js"></script>
</body>
</html>< GitHub Pages deployment test -->
